#!/bin/sh

###########################
##  Configurer for Axel  ##
##                       ##
## Copyright 2001 Lintux ##
###########################

prefix='/usr/local'
bindir='$prefix/bin'
etcdir='$prefix/etc'
mandir='$prefix/share/man'
locale='$prefix/share/locale'

CFGDIR='./cfg/'
MAKESETTINGS="${CFGDIR}Makefile.settings"
CONFIG_H="${CFGDIR}config.h"

i18n=0
debug=0
strip=1
ftp=1
metalink=0
search=0
ssl=0

arch=`uname -s`

while [ -n "$1" ]; do
	e="`expr "$1" : '--\(.*=.*\)'`"
	if [ -z "$e" ]; then
		cat<<EOF
Axel configure

Usage: $0 [OPTIONS]

Option		Description				Default

--prefix=...	Directories to put files in		$prefix
--bindir=...						$bindir
--etcdir=...						$etcdir
--mandir=...						$mandir
--locale=...						$locale

--i18n=0/1	Disable/enable internationalization	$i18n
--debug=0/1	Disable/enable debugging		$debug
--strip=0/1	Disable/enable binary stripping		$strip
--ftp=0/1	Disable/enable FTP support		$ftp
--metalink=0/1	Disable/enable Metalink support		$metalink
--search=0/1	Disable/enable filehosting.com support	$search
--ssl=0/1	Disable/enable HTTPS/FTPS support	$ssl
EOF
		exit;
	fi
	eval "$e"
	shift;
done

# Expand $prefix
bindir=`eval echo $bindir`
etcdir=`eval echo $etcdir`
mandir=`eval echo $mandir`
locale=`eval echo $locale`

mkdir -p "${CFGDIR}"

cat<<EOF>"${MAKESETTINGS}"
## Axel settings, generated by configure
PREFIX=$prefix
BINDIR=$bindir
ETCDIR=$etcdir
MANDIR=$mandir
LOCALE=$locale

OUTFILE=axel
ARCH=$arch

DESTDIR=
LFLAGS=

EOF

cat<<EOF>"${CONFIG_H}"
/* Axel settings, generated by configure */
#define _REENTRANT
#define _THREAD_SAFE
#define ETCDIR "$etcdir"
#define LOCALE "$locale"
#define ARCH "$arch"

EOF

if [ "$i18n" = "1" ]; then
	if type msgfmt > /dev/null 2> /dev/null; then :;else
		echo 'WARNING: Internationalization disabled, you don'\''t have the necessary files'
		echo '         installed.'
		echo ''
		i18n=0;
	fi;
fi

echo 'CFLAGS=-Wall -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -g -Os' >> "${MAKESETTINGS}"
echo 'CFLAGS_TEST=' >> "${MAKESETTINGS}"
echo 'LFLAGS_TEST=-lcunit' >> "${MAKESETTINGS}"

if [ "$debug" = "1" ]; then
	echo 'DEBUG=1' >> "${MAKESETTINGS}"
	echo '#define DEBUG' >> "${CONFIG_H}"
fi

if [ "$i18n" = "1" ]; then
	echo 'I18N=1' >> "${MAKESETTINGS}"
	echo '#define I18N' >> "${CONFIG_H}"
	if cat /usr/local/include/libintl.h > /dev/null 2> /dev/null; then
		echo 'CFLAGS+=-I/usr/local/include' >> "${MAKESETTINGS}"
		echo 'LFLAGS+=-L/usr/local/lib' >> "${MAKESETTINGS}"
	fi;
fi

if [ "${CC}" != "" ]; then
	echo "CC=${CC}" >> "${MAKESETTINGS}"
elif type gcc > /dev/null 2> /dev/null; then
	echo 'CFLAGS+=-std=c99 -Wextra' >> "${MAKESETTINGS}"
	echo "CC=gcc" >> "${MAKESETTINGS}"
elif type cc > /dev/null 2> /dev/null; then
	echo "CC=cc" >> "${MAKESETTINGS}"
else
	echo 'Cannot find a C compiler, aborting.'
	exit 1;
fi

if [ "$strip" = 1 ]; then
	echo 'The strip option is enabled. This should not be a problem usually, but on some'
	echo 'systems it breaks stuff.'
	echo
	if [ "$debug" = 1 ]; then
		echo 'WARNING: Stripping binaries does not make sense when debugging. Stripping disabled.'
		strip=0;
	elif type strip > /dev/null 2> /dev/null; then
		echo "STRIP=strip" >> "${MAKESETTINGS}";
	elif /bin/test -x /usr/ccs/bin/strip; then
		echo "STRIP=/usr/ccs/bin/strip" >> "${MAKESETTINGS}";
	else
		echo 'No strip utility found, cannot remove unnecessary parts from executable.'
		strip=0;
	fi;
fi

if [ "$ftp" = "1" ]; then
	echo '#define FTP' >> "${CONFIG_H}";
fi

if [ "$metalink" = "1" ]; then
	echo '#define METALINK' >> "${CONFIG_H}";
fi

if [ "$ssl" = "1" ]; then
	echo '#define SSL' >> "${CONFIG_H}";
fi

case "$arch" in
FreeBSD )
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	echo 'LFLAGS+=-pthread' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'Please keep in mind that you need GNU make to make Axel!'
	echo ''
;;
OpenBSD )
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	echo 'LFLAGS+=-pthread' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'Please keep in mind that you need GNU make to make Axel!'
	echo ''
;;
NetBSD )
	echo 'WARNING: NetBSD not tested! Using OpenBSD settings.'
	echo '         Please send me your results so I can update this!'
	echo ''
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	echo 'LFLAGS+=-pthread' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'Please keep in mind that you need GNU make to make Axel!'
	echo ''
;;
Darwin )
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	echo 'LFLAGS+=-lpthread' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo '#define DARWIN' >> "${CONFIG_H}"
	echo 'Please keep in mind that you need GNU make to make Axel!'
	echo ''
;;
Linux | GNU/kFreeBSD)
	echo 'LFLAGS+=-lpthread' >> "${MAKESETTINGS}"
;;
SunOS )
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	echo '#define BSD_COMP' >> "${CONFIG_H}"
	echo 'LFLAGS+=-lpthread -lsocket -lnsl' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'Please keep in mind that you need GNU make to make Axel!'
	echo ''
;;
CYGWIN_* )
	echo 'LFLAGS+=-lpthread' >> "${MAKESETTINGS}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'OUTFILE=axel.exe' >> "${MAKESETTINGS}"
;;
* )
	echo 'LFLAGS+=-lpthread' >> "${MAKESETTINGS}"
	echo '#define NOGETOPTLONG' >> "${CONFIG_H}"
	if [ "$i18n" = "1" ]; then
		echo 'LFLAGS+=-lintl' >> "${MAKESETTINGS}";
	fi
	echo 'WARNING: This architecture is unknown!'
	echo ''
	echo 'That does not mean Axel will not work, it just means I'\''ve never had the chance'
	echo 'to test Axel on it. It'\''d be a great help if you could send me more information'
	echo 'about your platform so I can add it to the build tools.'
	echo 'You can try to build the program now, if you wish, this default setup might'
	echo 'just work.'
	echo ''
;;
esac

echo 'Configuration done:'
if [ "$i18n" = "1" ]; then
	echo '  Internationalization enabled.';
else
	echo '  Internationalization disabled.';
fi
if [ "$debug" = "1" ]; then
	echo '  Debugging enabled.';
else
	echo '  Debugging disabled.';
fi
if [ "$strip" = "1" ]; then
	echo '  Binary stripping enabled.';
else
	echo '  Binary stripping disabled.';
fi
if [ "$ftp" = "1" ]; then
	echo '  FTP support enabled.';
else
	echo '  FTP support disabled.';
fi
if [ "$metalink" = "1" ]; then
	echo '  Metalink support enabled.';
else
	echo '  Metalink support disabled.';
fi
if [ "$search" = "1" ]; then
	echo '  filesearching.com support enabled.';
else
	echo '  filesearching.com support disabled.';
fi
if [ "$ssl" = "1" ]; then
	echo '  SSL support enabled.';
else
	echo '  SSL support disabled.';
fi
