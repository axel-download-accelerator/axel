dist: xenial

language: c

cache:
  ccache: true
  directories:
    - autom4te.cache
    - m4

before_install:
  - export HOMEBREW_NO_AUTO_UPDATE=true

addons:
  apt:
    packages:
      - autoconf-archive
      - autopoint
      - clang
      - libssl-dev
      - linux-libc-dev
      - txt2man
  homebrew:
    update: true
    packages:
      - autoconf-archive
      - gettext
      - openssl
      - pkg-config

env:
  global:
    - G_CFLAGS="-O3 -fPIC"
    - MAKEFLAGS="-j4"
    - target=distcheck
  matrix:
    - CONF_FLAGS="--without-ssl"
    - CONF_FLAGS="--with-ssl"

os:
  - linux
  - osx

compiler:
  - gcc
  - clang

matrix:
  exclude:
    - os: osx
      compiler: gcc

script:
  - if [ "${TRAVIS_OS_NAME}" = osx ]; then
      wget -P /tmp https://github.com/mvertes/txt2man/archive/txt2man-1.6.0.tar.gz;
      tar -xvf /tmp/txt2man-1.6.0.tar.gz;
      pushd txt2man-txt2man-1.6.0 && make install && popd;
      target=all
      GETTEXT="/usr/local/opt/gettext"
      OPENSSL="/usr/local/opt/openssl";
      export LIBRARY_PATH="$GETTEXT/lib"
             ACLOCAL_PATH="$GETTEXT/share/aclocal"
             CPATH="$OPENSSL/include:$GETTEXT/include"
             PKG_CONFIG_PATH="$OPENSSL/lib/pkgconfig"
             PATH="$GETTEXT/bin:$PATH";
    fi
  - autoreconf -fiv &&
    ./configure $CONF_FLAGS CFLAGS="$G_CFLAGS" &&
    make DIST_TARGETS=dist-gzip GZIP_ENV=--fast $target
